/**
 * @fileoverview File context detection utilities for lint-my-lines.
 * @author lint-my-lines
 *
 * This module provides utilities for detecting file types based on filename
 * patterns. It's used by config presets to apply different rules to different
 * file types (test files, generated files, minified files).
 *
 * @example
 * const { isTestFile, detectFileContext } = require("./file-context-utils");
 *
 * if (isTestFile("src/utils.test.js")) {
 *   // Apply relaxed rules
 * }
 *
 * const context = detectFileContext("dist/bundle.min.js");
 * // { isTestFile: false, isGeneratedFile: true, isMinifiedFile: true }
 */
"use strict";

// ---------------------------------------------------------------------------
// File Pattern Constants
// ---------------------------------------------------------------------------

/**
 * Patterns that identify test files.
 * Includes common testing framework conventions.
 *
 * @type {RegExp[]}
 */
const TEST_FILE_PATTERNS = [
  // Jest, Mocha, Vitest patterns
  /\.test\.[jt]sx?$/i,
  /\.spec\.[jt]sx?$/i,

  // Test directories (with or without leading slash)
  /__tests__\//i,
  /(^|\/)tests?\//i,
  /(^|\/)test\//i,

  // Storybook
  /\.stories\.[jt]sx?$/i,

  // End-to-end tests
  /\.e2e\.[jt]sx?$/i,

  // Cypress
  /\.cy\.[jt]sx?$/i,

  // Playwright
  /\.pw\.[jt]sx?$/i,
];

/**
 * Patterns that identify generated files.
 * These files are typically auto-generated and shouldn't be manually edited.
 *
 * @type {RegExp[]}
 */
const GENERATED_FILE_PATTERNS = [
  // Explicit generated markers
  /\.generated\.[jt]sx?$/i,
  /\.g\.[jt]sx?$/i,

  // Build output directories (with or without leading slash)
  /(^|\/)dist\//i,
  /(^|\/)build\//i,
  /(^|\/)out\//i,
  /(^|\/)output\//i,

  // TypeScript declaration files
  /\.d\.ts$/i,
  /\.d\.mts$/i,
  /\.d\.cts$/i,

  // Generated directories (with or without leading slash)
  /__generated__\//i,
  /(^|\/)generated\//i,

  // Node modules (always treat as generated)
  /(^|\/)node_modules\//i,

  // Coverage output
  /(^|\/)coverage\//i,

  // Cache directories
  /(^|\/)\.cache\//i,
  /(^|\/)\.next\//i,
  /(^|\/)\.nuxt\//i,
];

/**
 * Patterns that identify minified files.
 * These files are compressed and should not be linted.
 *
 * @type {RegExp[]}
 */
const MINIFIED_FILE_PATTERNS = [
  // Standard minified files
  /\.min\.[jt]sx?$/i,
  /\.min\.css$/i,
  /\.min\.mjs$/i,

  // Bundle files (often minified)
  /\.bundle\.[jt]sx?$/i,

  // Alternative naming conventions
  /-min\.[jt]sx?$/i,
  /_min\.[jt]sx?$/i,

  // Vendor bundles
  /vendor\.[jt]sx?$/i,
];

/**
 * Content markers that indicate a generated file.
 * These are checked against the first few lines of file content.
 *
 * @type {string[]}
 */
const GENERATED_CONTENT_MARKERS = [
  "@generated",
  "@auto-generated",
  "AUTO-GENERATED",
  "DO NOT EDIT",
  "Do not edit",
  "This file is auto-generated",
  "This file was auto-generated",
  "Generated by",
  "Automatically generated",
  "AUTOGENERATED",
  "Code generated by",
];

// ---------------------------------------------------------------------------
// Detection Functions
// ---------------------------------------------------------------------------

/**
 * Check if a filename matches any pattern in the given array.
 *
 * @param {string} filename - The filename or path to check
 * @param {RegExp[]} patterns - Array of patterns to match against
 * @returns {boolean} True if any pattern matches
 */
function matchesAnyPattern(filename, patterns) {
  if (!filename || typeof filename !== "string") {
    return false;
  }
  return patterns.some((pattern) => pattern.test(filename));
}

/**
 * Check if a file is a test file based on its filename.
 *
 * @param {string} filename - The filename or path to check
 * @returns {boolean} True if the file is a test file
 *
 * @example
 * isTestFile("src/utils.test.js");  // true
 * isTestFile("__tests__/foo.js");   // true
 * isTestFile("src/utils.js");       // false
 */
function isTestFile(filename) {
  return matchesAnyPattern(filename, TEST_FILE_PATTERNS);
}

/**
 * Check if a file is a generated file based on its filename.
 *
 * @param {string} filename - The filename or path to check
 * @returns {boolean} True if the file is a generated file
 *
 * @example
 * isGeneratedFile("dist/bundle.js");     // true
 * isGeneratedFile("types/index.d.ts");   // true
 * isGeneratedFile("src/utils.js");       // false
 */
function isGeneratedFile(filename) {
  return matchesAnyPattern(filename, GENERATED_FILE_PATTERNS);
}

/**
 * Check if a file is a minified file based on its filename.
 *
 * @param {string} filename - The filename or path to check
 * @returns {boolean} True if the file is a minified file
 *
 * @example
 * isMinifiedFile("dist/app.min.js");    // true
 * isMinifiedFile("vendor.bundle.js");   // true
 * isMinifiedFile("src/utils.js");       // false
 */
function isMinifiedFile(filename) {
  return matchesAnyPattern(filename, MINIFIED_FILE_PATTERNS);
}

/**
 * Check if file content indicates it's generated.
 * Checks the first portion of content for generated markers.
 *
 * @param {string} content - File content (or first portion)
 * @returns {boolean} True if content indicates generated file
 *
 * @example
 * hasGeneratedMarker("// @generated\nconst x = 1;");  // true
 * hasGeneratedMarker("const x = 1;");                  // false
 */
function hasGeneratedMarker(content) {
  if (!content || typeof content !== "string") {
    return false;
  }

  // Only check the first 500 characters for performance
  const header = content.slice(0, 500);

  return GENERATED_CONTENT_MARKERS.some((marker) =>
    header.includes(marker)
  );
}

/**
 * Detect the full context of a file based on its filename.
 * Returns an object with all file type flags.
 *
 * @param {string} filename - The filename or path to check
 * @returns {Object} File context object
 * @returns {boolean} returns.isTestFile - Whether it's a test file
 * @returns {boolean} returns.isGeneratedFile - Whether it's a generated file
 * @returns {boolean} returns.isMinifiedFile - Whether it's a minified file
 *
 * @example
 * detectFileContext("dist/bundle.min.js");
 * // { isTestFile: false, isGeneratedFile: true, isMinifiedFile: true }
 */
function detectFileContext(filename) {
  return {
    isTestFile: isTestFile(filename),
    isGeneratedFile: isGeneratedFile(filename),
    isMinifiedFile: isMinifiedFile(filename),
  };
}

/**
 * Get the glob patterns for test files.
 * Useful for creating ESLint config file patterns.
 *
 * @returns {string[]} Array of glob patterns
 */
function getTestFileGlobs() {
  return [
    "**/*.test.js",
    "**/*.test.ts",
    "**/*.test.jsx",
    "**/*.test.tsx",
    "**/*.spec.js",
    "**/*.spec.ts",
    "**/*.spec.jsx",
    "**/*.spec.tsx",
    "**/__tests__/**/*.js",
    "**/__tests__/**/*.ts",
    "**/__tests__/**/*.jsx",
    "**/__tests__/**/*.tsx",
    "**/tests/**/*.js",
    "**/tests/**/*.ts",
    "**/*.stories.js",
    "**/*.stories.ts",
    "**/*.stories.jsx",
    "**/*.stories.tsx",
    "**/*.e2e.js",
    "**/*.e2e.ts",
    "**/*.cy.js",
    "**/*.cy.ts",
  ];
}

/**
 * Get the glob patterns for generated files.
 * Useful for creating ESLint config ignore patterns.
 *
 * @returns {string[]} Array of glob patterns
 */
function getGeneratedFileGlobs() {
  return [
    "**/dist/**",
    "**/build/**",
    "**/out/**",
    "**/output/**",
    "**/*.generated.js",
    "**/*.generated.ts",
    "**/*.g.js",
    "**/*.g.ts",
    "**/__generated__/**",
    "**/generated/**",
    "**/node_modules/**",
    "**/coverage/**",
    "**/.cache/**",
    "**/.next/**",
    "**/.nuxt/**",
    "**/*.d.ts",
    "**/*.d.mts",
    "**/*.d.cts",
  ];
}

/**
 * Get the glob patterns for minified files.
 * Useful for creating ESLint config ignore patterns.
 *
 * @returns {string[]} Array of glob patterns
 */
function getMinifiedFileGlobs() {
  return [
    "**/*.min.js",
    "**/*.min.ts",
    "**/*.min.mjs",
    "**/*.min.css",
    "**/*.bundle.js",
    "**/*.bundle.ts",
    "**/*-min.js",
    "**/*_min.js",
    "**/vendor.js",
    "**/vendor.ts",
  ];
}

// ---------------------------------------------------------------------------
// Module Exports
// ---------------------------------------------------------------------------

module.exports = {
  // Pattern constants (for testing/extension)
  TEST_FILE_PATTERNS,
  GENERATED_FILE_PATTERNS,
  MINIFIED_FILE_PATTERNS,
  GENERATED_CONTENT_MARKERS,

  // Detection functions
  isTestFile,
  isGeneratedFile,
  isMinifiedFile,
  hasGeneratedMarker,
  detectFileContext,

  // Glob pattern helpers
  getTestFileGlobs,
  getGeneratedFileGlobs,
  getMinifiedFileGlobs,
};
